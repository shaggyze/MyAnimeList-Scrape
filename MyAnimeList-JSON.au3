;MyAnimeList-JSON 0.0.0.10 by ShaggyZE
#AutoIt3Wrapper_icon=mal.ico
#pragma compile(inputboxres, true)
#region Includes
#include-once
#include <Inet.au3>
#include <Json.au3>
#include <String.au3>
#include <MsgBoxConstants.au3>
#include <GuiButton.au3>
#include <EditConstants.au3>
#include <GUIConstantsEx.au3>
#include <GuiComboBoxEx.au3>
#include <WindowsConstants.au3>
#include <GDIPlus.au3>
#include <IE.au3>
#include <Math.au3>
#include <GUIListView.au3>
#include <WinAPI.au3>
#include <File.au3>
#include <Misc.au3>
#include <vkConstants.au3>
#include <GUIScrollBars_Ex.au3>
#include <GuiScrollBars.au3>
#include <GuiScroll.au3>
#include <GUICtrl_SetResizing.au3>
#include <StaticConstants.au3>
#include <ProgressConstants.au3>
#include <ColorConstants.au3>
#include <GUIMenu.au3>
#include <GuiEdit.au3>
#endregion Includes
Global $szText, $szText, $szURL, $szID, $sValue1, $sValue2, $szDelay, $Username, $CSS, $Method, $anime_id, $anime_ids, $manga_id, $manga_ids
Local $hGUI = GUICreate("MyAnimeList-JSON                                                                           To Pause or Close Click the MAL Icon in your System Tray at the Bottom Right", 900, 430, -1, -1, -1)
Local $hSysMenu = _GUICtrlMenu_GetSystemMenu($hGUI)
_GUICtrlMenu_DeleteMenu($hSysMenu, $SC_CLOSE, False)
_GUICtrlMenu_DeleteMenu($hSysMenu, $SC_MAXIMIZE, False)
GUISetIcon(@ScriptDir & "\mal.ico")
;GUI Frontend
$ButtonS = GUICtrlCreateButton("Start", 5, 5, 45, 20)
GUICtrlSetTip(-1, "Click to Start")
$UsernameINP = GUICtrlCreateInput("ShaggyZE", 80, 5, 100, 20)
GUICtrlSetTip(-1, "Your Mal Username")
GUICtrlCreateLabel("Output", 225, 10, 65, 20)
GUICtrlSetTip(-1, "This is where your CSS code will be")
$Progress = GUICtrlCreateLabel("", 60, 40, 100, 20, $SS_CENTER, $WS_EX_TOPMOST)
GUICtrlSetTip(-1, "")
GUICtrlCreateLabel("Delay", 5, 60, 65, 20)
GUICtrlSetTip(-1, "Milliseconds between Scraping MyAnimeList.net")
$DelayINP = GUICtrlCreateInput("2000", 5, 80, 40, 20)
GUICtrlSetTip(-1, "Milliseconds between Scraping MyAnimeList.net")
GUICtrlCreateLabel("Template", 5, 110, 65, 20)
GUICtrlSetTip(-1, "CSS Template")
$TemplateINP = GUICtrlCreateInput("#tags-[ID]:after {font-family: Finger Paint; content: '[DESC]';}", 5, 130, 220, 20)
GUICtrlSetTip(-1, "CSS Template")
GUICtrlCreateLabel("Method", 5, 160, 65, 20)
GUICtrlSetTip(-1, "Method of scraping Data for CSS")
$methodCMB = GUICtrlCreateCombo("MAL-Anime", 5, 180, 150, 20)
GUICtrlSetData(-1, "MAL-Manga|load.json-Anime-MAL|load.json-Manga-MAL|load.json-Anime-JSON|load.json-Manga-JSON|MAL-Anime-JSON|MAL-Manga-JSON")
GUICtrlSetTip(-1, "Method of scraping Data for CSS")
GUICtrlCreateLabel("Start and Finish", 5, 210, 100, 20)
GUICtrlSetTip(-1, "ID# from Start to Finsh")
$FromINP = GUICtrlCreateInput("0", 5, 230, 40, 20)
GUICtrlSetTip(-1, "Start ID#")
$ToINP = GUICtrlCreateInput("49500", 45, 230, 40, 20)
GUICtrlSetTip(-1, "Finish ID#")
$OutputINP = GuiCtrlCreateEdit("Newly generated code will be output here.", 225, 25, 675, 405, $ES_MULTILINE)
GUICtrlSetStyle($OutputINP, $WS_VSCROLL)
_GUICtrlEdit_SetReadOnly(ControlGetHandle($hGUI,"",$OutputINP),True)
GUICtrlSetTip(-1, "Newly generated code will be output here.")
GUISetState(@SW_SHOW)
$szFile1 = "scrape.txt"
$szFile2 = "mal.css"
$szFile3 = "scrape.html"
$x = @DesktopWidth - 150
$y = @DesktopHeight - 62.5
GUISetState(@SW_SHOW, $hGUI)
While GUIGetMsg() <> $GUI_EVENT_CLOSE
Sleep(10)
	$nMsg = GUIGetMsg()

	Switch $nMsg
		;Exit
		Case $GUI_EVENT_CLOSE
			Exit (20)
		;Start
		Case $ButtonS
			$Method = GUICtrlRead($methodCMB)
			If $Method = "MAL-Anime" Then
				$sValue1 = GUICtrlRead($FromINP)
				$sValue2 = GUICtrlRead($ToINP)
				If $sValue1 = "" Then $sValue1 = "0" And GUICtrlSetData($FromINP, 0)
				If $sValue2 = "" Then $sValue2 = "49500" And GUICtrlSetData($ToINP, "49500")
				FileDelete($szFile2)
				$CSS = GUICtrlRead($TemplateINP)
				$szText = '/* Generated by MyAnimeList-JSON https://github.com/shaggyze/MyAnimeList-JSON' & @CRLF & 'Template=' & $CSS & '*/'
				FileWrite($szFile2, $szText)
				ToolTip("Scraping MAL data...", $x, $y)
				Sleep(2000)
				_ScrapeMALAnime()
				FileDelete($szFile1)
				FileDelete($szFile3)
			ElseIf $Method = "MAL-Manga" Then
				$sValue1 = GUICtrlRead($FromINP)
				$sValue2 = GUICtrlRead($ToINP)
				If $sValue1 = "" Then $sValue1 = "0" And GUICtrlSetData($FromINP, 0)
				If $sValue2 = "" Then $sValue2 = "138900" And GUICtrlSetData($ToINP, "138900")
				FileDelete($szFile2)
				$CSS = GUICtrlRead($TemplateINP)
				$szText = '/* Generated by MyAnimeList-JSON https://github.com/shaggyze/MyAnimeList-JSON' & @CRLF & 'Template=' & $CSS & '*/'
				FileWrite($szFile2, $szText)
				ToolTip("Scraping MAL data...", $x, $y)
				Sleep(2000)
				_ScrapeMALManga()
				FileDelete($szFile1)
				FileDelete($szFile3)
			ElseIf $Method = "load.json-Anime-MAL" Then
				_ScrapeloadjsonAnimeMAL()
			ElseIf $Method = "load.json-Manga-MAL" Then
				_ScrapeloadjsonMangaMAL()
			EndIf
		Case Else
			;MsgBox(0,"",$nMsg)
	EndSwitch
WEnd


Func _ParseDESC($szID)
$parseStr =  FileRead($szFile1,FileGetSize($szFile1))
$parseStr =  StringReplace($parseStr, @LF, "")
$parseStr =  StringReplace($parseStr, @CR, "")
$parseStr =  StringReplace($parseStr, @CRLF, "")
$parseStr =  StringReplace($parseStr, '"', '')
$parseStr =  StringReplace($parseStr, "'", '')
$parseStr =  StringReplace($parseStr, "<br />", "")
$parseStr =  StringReplace($parseStr, "<i>", "")
$parseStr =  StringReplace($parseStr, "</i>", "")
$parseStr =  StringReplace($parseStr, "&quot;", '\"')
$parseStr =  StringReplace($parseStr, "&eacute;", "é")
$parseStr =  StringReplace($parseStr, "&euml;", "é")
$parseStr =  StringReplace($parseStr, "&auml;", "ä")
$parseStr =  StringReplace($parseStr, "Å", "o")
$parseStr =  StringReplace($parseStr, "&amp;", "&")
$parseStr =  StringReplace($parseStr, "&rsquo;", "")
$parseStr =  StringReplace($parseStr, "&#039;", "")
$parseStr =  StringReplace($parseStr, "&#x27;", "")
$parseStr =  StringReplace($parseStr, "&mdash;", "-")
$szText1 = @CRLF & $CSS
$szText1 = StringReplace($szText1, "[ID]", $szID)
$szText1 = StringReplace($szText1, "[DESC]", $parseStr)
FileWrite($szFile2, $szText1)
EndFunc   ;==>_ParseTag

Func _ScrapeMALAnime()
GUICtrlSetData($OutputINP, "")
ToolTip("Scanning from " & $sValue1 & " to " & $sValue2, $x, $y)
Sleep (2000)
While $sValue1 <= $sValue2
	$szID = $sValue1
	GUICtrlSetData($Progress, $sValue1 & " of " & $sValue2)
	$szURL = "https://myanimelist.net/anime/" & $szID
	ToolTip($szID & " Scanned.", $x, $y)
	Sleep(GUICtrlRead($DelayINP))
    $source = _INetGetSource($szURL)
    FileDelete($szFile3)
	FileWrite(@ScriptDir & "\" & $szFile3, $source)
    Local $read = FileRead(@ScriptDir & "\" & $szFile3)
    Local $readtitle = _StringBetween($read, '<p itemprop="description">', '</p>')
    If IsArray($readtitle) Then
		_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
		_ParseDESC($szID)
    Else
		Local $readtitle = _StringBetween($read, 'Synopsis</h2></div>', '<')
		If IsArray($readtitle) Then
			_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
			_ParseDESC($szID)
		EndIf
    EndIf
	Local $read2 = FileRead(@ScriptDir & "\" & $szFile2)
	GUICtrlSetData($OutputINP, $read2)
	$sValue1 = $sValue1 + 1
WEnd
EndFunc   ;==>_ScrapeMALAnime

Func _ScrapeMALManga()
GUICtrlSetData($OutputINP, "")
ToolTip("Scanning from " & $sValue1 & " to " & $sValue2, $x, $y)
Sleep (2000)
While $sValue1 <= $sValue2
	$szID = $sValue1
	GUICtrlSetData($Progress, $sValue1 & " of " & $sValue2)
	$szURL = "https://myanimelist.net/manga/" & $szID
	ToolTip($szID & " Scanned.", $x, $y)
	Sleep(GUICtrlRead($DelayINP))
    $source = _INetGetSource($szURL)
    FileDelete($szFile3)
	FileWrite(@ScriptDir & "\" & $szFile3, $source)
    Local $read = FileRead(@ScriptDir & "\" & $szFile3)
    Local $readtitle = _StringBetween($read, '<span itemprop="description">', '</span>') ;read URL and title from file
    If IsArray($readtitle) Then
		_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
		_ParseDESC($szID)
    Else
		Local $readtitle = _StringBetween($read, '</div>Synopsis</h2>', '<') ;read URL and title from file
		If IsArray($readtitle) Then
			_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
			_ParseDESC($szID)
		EndIf
    EndIf
	Local $read2 = FileRead(@ScriptDir & "\" & $szFile2)
	GUICtrlSetData($OutputINP, $read2)
	$sValue1 = $sValue1 + 1
WEnd
EndFunc   ;==>_ScrapeMALAnime

Func _ScrapeloadjsonAnimeMAL()
_GetloadjsonAnimeMAL()
EndFunc   ;==>_ScrapeloadjsonAnimeMAL

Func _ScrapeloadjsonMangaMAL()
_GetloadjsonMangaMAL()
EndFunc   ;==>_ScrapeloadjsonMangaMAL

Func _GetloadjsonAnimeMAL()
Local $i = 0

While 1
	$Username = GUICtrlRead($UsernameINP)
	$URL = "https://myanimelist.net/animelist/" & $Username & "/load.json?status=7&offset=" & $i
	$data = _INetGetSource($URL)
	$object = Json_Decode($data)
	GUICtrlSetData($OutputINP, $data)
	If $object = "" Then ExitLoop
    If @error Then ExitLoop
        $anime_id = Json_Get($object, 'anime_id')
        ConsoleWrite('$anime_id = ' & $anime_id & @CRLF ) ;### Debug Console
		$anime_ids = $anime_ids & $anime_id
    $i += 300
WEnd
EndFunc   ;==>_GetloadjsonAnimeMAL

Func _GetloadjsonMangaMAL()
Local $i = 0

While 1
	$Username = GUICtrlRead($UsernameINP)
	$URL = "https://myanimelist.net/mangalist/" & $Username & "/load.json?status=7&offset=" & $i
	$data = _INetGetSource($URL)
	$object = Json_Decode($data)
	GUICtrlSetData($OutputINP, $data)
	If $object = "" Then ExitLoop
    If @error Then ExitLoop
    ;    $manga_id = Json_Get($object, 'mangaid')
    ;    ConsoleWrite('$mangaid = ' & $manga_id & @CRLF ) ;### Debug Console
	;	$manga_ids = $manga_ids & $manga_id
    ;$i += 300
WEnd
EndFunc   ;==>_GetloadjsonMangaMAL