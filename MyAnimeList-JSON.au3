;MyAnimeList-JSON 0.0.0.1 by ShaggyZE
#AutoIt3Wrapper_icon=mal.ico
#pragma compile(inputboxres, true)
#include <MsgBoxConstants.au3> ;needed for input boxes
#include "INet2.au3"; needed for get source (hmtl)
#include <String.au3>; needed for StringBetween
#include <MsgBoxConstants.au3>; needed for MsgBox
#include <File.au3>; needed for _FileWriteFromArray
Global $szText, $szText, $szURL, $szAnime
Global $sValue1 = InputBox("Input Starting Anime ID#", "Which anime #ID would you like to start with?", "41621", " M5")
Global $sValue2 = InputBox("Input Finishing Anime ID#", "Which anime #ID would you like to finish with?", "45700", " M5")
Global $szDelay = InputBox("Input Delay", "How long of a delay between anime scraping?(1000 equals 1 second)", "2000", " M5")
$szFile1 = "tag.txt"
$szFile2 = "maltags.css"
$szFile3 = "tags.html"
$x = @DesktopWidth - 150
$y = @DesktopHeight - 62.5
ToolTip("Scraping MAL data...", $x, $y)
Sleep(2000); Sleep to give tooltip time to display
FileDelete($szFile2)
$szText = '/* Generated by MAL List Tool http://burntjello.webs.com' & @CRLF & 'Template=#tags-[ID]:after {font-family: Finger Paint; content: "[DESC]";}' & @CRLF & 'MatchTemplate=#more[ID] ' & @CRLF & '*/'
FileWrite($szFile2,$szText)
 _Scrape()
FileDelete($szFile1)
FileDelete($szFile3)
ToolTip("Exiting...", $x, $y)
Sleep(2000); Sleep to give tooltip time to display
Exit

Func _ParseTag($szAnime)
$szText1 = FileRead($szFile1,FileGetSize($szFile1))
$szText1 = StringReplace($szText1, @LF, "")
$szText1 = StringReplace($szText1, @CR, "")
$szText1 = StringReplace($szText1, @CRLF, "")
$szText1 = StringReplace($szText1, '"', '')
$szText1 = StringReplace($szText1, "<br />", "")
$szText1 = StringReplace($szText1, "<i>", "")
$szText1 = StringReplace($szText1, "</i>", "")
$szText1 = StringReplace($szText1, "&quot;", '\"')
$szText1 = StringReplace($szText1, "&eacute;", "é")
$szText1 = StringReplace($szText1, "&euml;", "é")
$szText1 = StringReplace($szText1, "&auml;", "ä")
$szText1 = StringReplace($szText1, "Å", "o")
$szText1 = StringReplace($szText1, "&amp;", "&")
$szText1 = StringReplace($szText1, "&rsquo;", "'")
$szText1 = StringReplace($szText1, "&#039;", "'")
$szText1 = StringReplace($szText1, "&mdash;", "-")
$szText1 =  @CRLF & '#tags-' & $szAnime & ':after {font-family: Finger Paint; content: "' & $szText1 & '";}'
FileWrite($szFile2,$szText1)
EndFunc   ;==>_ParseTag

Func _Scrape()
For $szAnime = $sValue1 to $sValue2
	$szURL = "https://myanimelist.net/anime/" & $szAnime
	ToolTip($szAnime & " Scanned.", $x, $y)
	Sleep($szDelay); Sleep to give tooltip time to display
    $source = _INetGetSource($szURL) ;get html
    FileDelete($szFile3)
	FileWrite(@ScriptDir & "\" & $szFile3, $source); save file
    Local $read = FileRead(@ScriptDir & "\" & $szFile3) ;read file
    Local $readtitle = _StringBetween($read, '<p itemprop="description">', '</p>') ;read URL and title from file
    If IsArray($readtitle) Then
		_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
		_ParseTag($szAnime)
    Else
		Local $readtitle = _StringBetween($read, 'Synopsis</h2></div>', '<') ;read URL and title from file
		If IsArray($readtitle) Then
			_FileWriteFromArray(@ScriptDir & '\' & $szFile1, $readtitle)
			_ParseTag($szAnime)
		EndIf
    EndIf
Next
EndFunc   ;==>_Scrape